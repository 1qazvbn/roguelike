import {ENTITY,TEAM} from '../engine/Types.js';
import {norm,V,sub} from '../util/Math2D.js';
function pathDir(level,start,goal){const w=level.width,h=level.height;const q=[start];const prev=new Map([[start.x+','+start.y,null]]);while(q.length){const c=q.shift();if(c.x===goal.x&&c.y===goal.y)break;for(const n of[{x:c.x+1,y:c.y},{x:c.x-1,y:c.y},{x:c.x,y:c.y+1},{x:c.x,y:c.y-1}]){const k=n.x+','+n.y;if(n.x<0||n.y<0||n.x>=w||n.y>=h)continue;if(level.isWall(n.x,n.y)||prev.has(k))continue;prev.set(k,c);q.push(n);}}
let cur=goal,k=cur.x+','+cur.y;if(!prev.has(k))return V();let prevCell=prev.get(k);while(prevCell&&prev.get(prevCell.x+','+prevCell.y)){cur=prevCell;prevCell=prev.get(cur.x+','+cur.y);}return norm(sub({x:cur.x+0.5,y:cur.y+0.5},{x:start.x+0.5,y:start.y+0.5}));}
export function aiSystem(entities,level,player,dt,rng){for(const e of entities){if(e.kind!==ENTITY.ENEMY)continue; if(e.type==='chaser'){const dir=pathDir(level,{x:Math.floor(e.pos.x/32),y:Math.floor(e.pos.y/32)},{x:Math.floor(player.pos.x/32),y:Math.floor(player.pos.y/32)});e.vel= {x:dir.x*e.speed,y:dir.y*e.speed};}else if(e.type==='shooter'){const toP=sub(player.pos,e.pos);const d=Math.hypot(toP.x,toP.y);if(d>150){const n=norm(toP);e.vel={x:n.x*e.speed,y:n.y*e.speed};}else if(d<100){const n=norm(toP);e.vel={x:-n.x*e.speed,y:-n.y*e.speed};}else e.vel={x:0,y:0};e.fire=e.fire||0;e.fire-=dt;if(e.fire<=0){e.fire=1;const angle=Math.atan2(toP.y,toP.x);e.shootAngle=angle;}}}}
